<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kotappakonda Thodu</title>
    <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f8f9fa; color: #333; margin: 0; font-family: sans-serif; }
        .spiritual-header { background: #1a1a1a; font-size: 1.8rem; font-weight: 800; text-align: center; padding: 20px; color: #FFD700; text-shadow: 0px 0px 15px rgba(255, 215, 0, 0.6); }
        .status-bar { background: #FFD700; color: black; font-weight: 800; text-align: center; padding: 10px; font-size: 1rem; text-transform: uppercase; border-bottom: 2px solid #eab308; }
        #map { width: 100%; height: 60vh; }
        .btn-container { padding: 20px; display: flex; justify-content: center; background: white; }
        .share-btn { background: #25D366; color: white; width: 100%; max-width: 500px; padding: 18px; border-radius: 12px; font-weight: bold; font-size: 1.2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; border: none; }
    </style>
</head>
<body>
    <div class="spiritual-header">త్రికోటేశ్వరస్వామి దీవెనలతో</div>
    <div id="sector-display" class="status-bar">GPS మ్యాప్ సిద్ధంగా ఉంది...</div>
    <div id="map"></div>
    <div class="btn-container">
        <button class="share-btn" onclick="shareLocation()">SHARE LOCATION ON WHATSAPP</button>
    </div>

    <script>
        let currentStatus = "Searching...";
        const hillCenter = [80.0384, 16.1485];
        
        const map = new maplibregl.Map({
            container: 'map',
            // SWITCHED TO BRIGHT STREET STYLE
            style: 'https://tiles.openfreemap.org/styles/bright', 
            center: hillCenter,
            zoom: 14
        });

        const geolocate = new maplibregl.GeolocateControl({ positionOptions: {enableHighAccuracy: true}, trackUserLocation: true, showUserLocation: true });
        map.addControl(geolocate);

        const circlePath = createCircle(hillCenter, 3.2);

        function createCircle(center, radiusKm) {
            const points = 128;
            const coords = [];
            for (let i = 0; i < points; i++) {
                const angle = (i / points) * (2 * Math.PI);
                const dx = radiusKm * Math.cos(angle) / (111.32 * Math.cos(center[1] * Math.PI / 180));
                const dy = radiusKm * Math.sin(angle) / 110.57;
                coords.push([center[0] + dx, center[1] + dy]);
            }
            coords.push(coords[0]);
            return coords;
        }

        map.on('load', () => {
            // Draw the Circle Perimeter in Blue (Professional look)
            map.addSource('perimeter', { 'type': 'geojson', 'data': { 'type': 'Feature', 'geometry': { 'type': 'Polygon', 'coordinates': [circlePath] } } });
            map.addLayer({ 'id': 'p-line', 'type': 'line', 'source': 'perimeter', 'paint': { 'line-color': '#2563eb', 'line-width': 4 } });
            
            geolocate.trigger();
        });

        geolocate.on('geolocate', (e) => {
            const lat = e.coords.latitude;
            const lon = e.coords.longitude;
            // Precise Circle Logic
            const dist = Math.sqrt(Math.pow(lat - 16.1485, 2) + Math.pow(lon - 80.0384, 2));
            let status = dist <= 0.03 ? "In Jathara Area" : "⚠️ Outside Jathara";

            if (status !== currentStatus) {
                currentStatus = status;
                document.getElementById('sector-display').innerText = currentStatus;
            }
        });

        function shareLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const msg = `*Kotappakonda Thodu*\n*Status*: ${currentStatus}\n*Live Map*: https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`;
                    window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
                });
            }
        }
    </script>
</body>
</html>
